name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v0.1.0)'
        required: true
        type: string

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, windows-latest, ubuntu-22.04]

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: npm install

      - name: Build and Release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ inputs.tag || github.ref_name }}
          releaseName: 'Incito ${{ inputs.tag || github.ref_name }}'
          releaseDraft: false
          prerelease: false

  update-gist:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Update latest.json Gist
        uses: actions/github-script@v7
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
          RELEASE_TAG: ${{ inputs.tag || github.ref_name }}
        with:
          script: |
            // Debug: Check environment variables
            const gistId = process.env.GIST_ID;
            const gistToken = process.env.GIST_TOKEN;

            console.log('=== DEBUG INFO ===');
            console.log(`GIST_ID set: ${!!gistId}`);
            console.log(`GIST_ID length: ${gistId ? gistId.length : 0}`);
            console.log(`GIST_ID value: ${gistId ? gistId.substring(0, 4) + '...' + gistId.substring(gistId.length - 4) : 'NOT SET'}`);
            console.log(`GIST_TOKEN set: ${!!gistToken}`);
            console.log(`GIST_TOKEN length: ${gistToken ? gistToken.length : 0}`);
            console.log('==================\n');

            // Get release by tag
            const tag = process.env.RELEASE_TAG;
            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: tag
            });

            const assets = release.data.assets;

            // Platform mapping: asset pattern -> Tauri platform identifier
            const platformMap = {
              '_aarch64.app.tar.gz': 'darwin-aarch64',
              '_x64.app.tar.gz': 'darwin-x86_64',
              '_x64-setup.nsis.zip': 'windows-x86_64',
              '_amd64.AppImage.tar.gz': 'linux-x86_64'
            };

            const platforms = {};

            for (const [pattern, platform] of Object.entries(platformMap)) {
              // Find the update bundle asset (not .sig)
              const bundleAsset = assets.find(a =>
                a.name.endsWith(pattern) && !a.name.endsWith('.sig')
              );

              // Find the corresponding signature file
              const sigAsset = assets.find(a =>
                a.name.endsWith(pattern + '.sig')
              );

              if (bundleAsset && sigAsset) {
                // Download signature content via fetch
                const sigResponse = await fetch(sigAsset.browser_download_url);
                const signature = (await sigResponse.text()).trim();

                platforms[platform] = {
                  signature: signature,
                  url: bundleAsset.browser_download_url
                };

                console.log(`✓ Found ${platform}: ${bundleAsset.name}`);
              } else {
                console.log(`⚠ Skipping ${platform}: bundle or signature not found`);
              }
            }

            // Construct latest.json
            const latestJson = {
              version: tag,
              notes: release.data.body || '',
              pub_date: release.data.published_at || new Date().toISOString(),
              platforms: platforms
            };

            console.log('\nConstructed latest.json:');
            console.log(JSON.stringify(latestJson, null, 2));

            // Debug: Show the Gist URL being called
            const gistUrl = `https://api.github.com/gists/${gistId}`;
            console.log(`\n=== GIST API CALL ===`);
            console.log(`URL: ${gistUrl}`);
            console.log(`Method: PATCH`);
            console.log(`=====================\n`);

            // Update Gist using fetch
            const gistResponse = await fetch(gistUrl, {
              method: 'PATCH',
              headers: {
                'Authorization': `token ${process.env.GIST_TOKEN}`,
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github+json'
              },
              body: JSON.stringify({
                files: {
                  'latest.json': {
                    content: JSON.stringify(latestJson, null, 2)
                  }
                }
              })
            });

            if (!gistResponse.ok) {
              const responseText = await gistResponse.text();
              console.log(`\n=== GIST API ERROR ===`);
              console.log(`Status: ${gistResponse.status}`);
              console.log(`Status Text: ${gistResponse.statusText}`);
              console.log(`Response: ${responseText}`);
              console.log(`X-RateLimit-Remaining: ${gistResponse.headers.get('x-ratelimit-remaining')}`);
              console.log(`X-OAuth-Scopes: ${gistResponse.headers.get('x-oauth-scopes')}`);
              console.log(`======================\n`);
              throw new Error(`Failed to update Gist: ${gistResponse.status} ${responseText}`);
            }

            console.log('\n✓ Successfully updated Gist');
